From 4b3467ec960cc2221d9bc6b0c0bc07a9d712bc40 Mon Sep 17 00:00:00 2001
From: Michal Brzozowski <miki@extremic.com>
Date: Sun, 21 Sep 2025 11:25:48 +0200
Subject: [PATCH 09/13] Focus on the most recent task when opening recents

Change-Id: I58d9be2708306f795ddbd6302405199762b045f9
---
 .../quickstep/views/LauncherRecentsView.java  | 40 +++++++++++++++++++
 1 file changed, 40 insertions(+)

diff --git a/quickstep/src/com/android/quickstep/views/LauncherRecentsView.java b/quickstep/src/com/android/quickstep/views/LauncherRecentsView.java
index 97f3d81486..6e1195c676 100644
--- a/quickstep/src/com/android/quickstep/views/LauncherRecentsView.java
+++ b/quickstep/src/com/android/quickstep/views/LauncherRecentsView.java
@@ -33,6 +33,7 @@ import android.content.Context;
 import android.os.Build;
 import android.util.AttributeSet;
 import android.view.MotionEvent;
+import android.view.View;
 
 import androidx.annotation.Nullable;
 
@@ -181,6 +182,10 @@ public class LauncherRecentsView extends RecentsView<QuickstepLauncher, Launcher
             runActionOnRemoteHandles(remoteTargetHandle ->
                     remoteTargetHandle.getTaskViewSimulator().setDrawsBelowRecents(true));
         }
+
+        if (finalState == OVERVIEW) {
+            focusMostRecentTaskForDpadIfNeeded();
+        }
     }
 
     @Override
@@ -201,6 +206,41 @@ public class LauncherRecentsView extends RecentsView<QuickstepLauncher, Launcher
         return result || mActivity.getStateManager().getState().overviewUi;
     }
 
+    private void focusMostRecentTaskForDpadIfNeeded() {
+        if (isInTouchMode() || isKeyboardTaskFocusPending()) {
+            return;
+        }
+
+        View currentFocus = findFocus();
+        if (currentFocus instanceof TaskView) {
+            return;
+        }
+
+        post(() -> {
+            if (isInTouchMode() || isKeyboardTaskFocusPending()) {
+                return;
+            }
+
+            View focused = findFocus();
+            if (focused instanceof TaskView) {
+                return;
+            }
+
+            TaskView mostRecent = getCurrentPageTaskView();
+            if (mostRecent == null) {
+                mostRecent = getRunningTaskView();
+            }
+            if (mostRecent == null) {
+                mostRecent = getTaskViewNearestToCenterOfScreen();
+            }
+
+            if (mostRecent != null && mostRecent.isAttachedToWindow()) {
+                mostRecent.requestFocus();
+                mostRecent.requestAccessibilityFocus();
+            }
+        });
+    }
+
     @Override
     protected DepthController getDepthController() {
         return mActivity.getDepthController();
-- 
2.34.1

