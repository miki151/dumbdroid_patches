From c5f3b00b97d8fc4bd91ddcede6d2d8e0cb447b0d Mon Sep 17 00:00:00 2001
From: Michal Brzozowski <miki@extremic.com>
Date: Thu, 24 Jul 2025 09:10:33 +0200
Subject: [PATCH 3/6] Add setting for power button behavior

Change-Id: I7c13216d9d08f514e99f7a80b02d0c1138fb30e6
---
 res/values/arrays.xml                         | 10 ++++++++
 res/values/strings.xml                        |  3 +++
 res/xml/button_settings.xml                   |  8 +++++++
 .../lineageparts/input/ButtonSettings.java    | 23 +++++++++++++++++--
 4 files changed, 42 insertions(+), 2 deletions(-)

diff --git a/res/values/arrays.xml b/res/values/arrays.xml
index 4649977..c982b18 100644
--- a/res/values/arrays.xml
+++ b/res/values/arrays.xml
@@ -99,6 +99,16 @@
         <item>1</item>
     </string-array>
 
+    <string-array name="power_button_action_entries" translatable="false">
+        <item>@string/power_button_action_screen_off</item>
+        <item>@string/power_button_action_go_home</item>
+    </string-array>
+
+    <string-array name="power_button_action_values" translatable="false">
+        <item>0</item>
+        <item>1</item>
+    </string-array>
+
     <!-- Volume key cursor control -->
     <string-array name="volbtn_cursor_control_entries" translatable="false">
         <item>@string/volbtn_cursor_control_off</item>
diff --git a/res/values/strings.xml b/res/values/strings.xml
index 5fc26cc..952c5a3 100644
--- a/res/values/strings.xml
+++ b/res/values/strings.xml
@@ -177,6 +177,9 @@
     <!-- Button settings -->
     <string name="button_pref_title">Buttons</string>
     <string name="hardware_keys_power_key_title">Power button</string>
+    <string name="power_button_action_title">Power button action</string>
+    <string name="power_button_action_screen_off">Always turn off the screen</string>
+    <string name="power_button_action_go_home">Go home first or turn off the screen</string>
     <string name="hardware_keys_home_key_title">Home button</string>
     <string name="hardware_keys_dpad_key_title">Dpad up/down buttons</string>
     <string name="dpad_screen_off_action_title">While the screen is off</string>
diff --git a/res/xml/button_settings.xml b/res/xml/button_settings.xml
index 4e6bde2..2d8425f 100644
--- a/res/xml/button_settings.xml
+++ b/res/xml/button_settings.xml
@@ -121,6 +121,14 @@
             android:dependency="torch_long_press_power_gesture"
             android:persistent="false" />
 
+        <ListPreference
+            android:key="power_button_action"
+            android:dialogTitle="@string/power_button_action_title"
+            android:title="@string/power_button_action_title"
+            android:entries="@array/power_button_action_entries"
+            android:entryValues="@array/power_button_action_values"
+            android:persistent="false" />
+
     </PreferenceCategory>
 
     <PreferenceCategory
diff --git a/src/org/lineageos/lineageparts/input/ButtonSettings.java b/src/org/lineageos/lineageparts/input/ButtonSettings.java
index 4595a00..c4ff71d 100644
--- a/src/org/lineageos/lineageparts/input/ButtonSettings.java
+++ b/src/org/lineageos/lineageparts/input/ButtonSettings.java
@@ -67,6 +67,7 @@ public class ButtonSettings extends SettingsPreferenceFragment
     private static final String KEY_HOME_LONG_PRESS = "hardware_keys_home_long_press";
     private static final String KEY_HOME_DOUBLE_TAP = "hardware_keys_home_double_tap";
     private static final String KEY_HOME_WAKE_SCREEN = "home_wake_screen";
+    private static final String KEY_POWER_BUTTON_ACTION = "power_button_action";
     private static final String KEY_DPAD_SCREEN_OFF = "hardware_keys_dpad_screen_off";
     private static final String KEY_DPAD_MUSIC_PLAYING = "hardware_keys_dpad_music_playing";
     private static final String KEY_DPAD_CALL_ACTIVE = "hardware_keys_dpad_call_active";
@@ -119,6 +120,7 @@ public class ButtonSettings extends SettingsPreferenceFragment
     private ListPreference mBackLongPressAction;
     private ListPreference mHomeLongPressAction;
     private ListPreference mHomeDoubleTapAction;
+    private ListPreference mPowerButtonAction;
     private ListPreference mDpadScreenOffAction;
     private ListPreference mDpadMusicPlayingAction;
     private ListPreference mDpadCallActiveAction;
@@ -166,9 +168,9 @@ public class ButtonSettings extends SettingsPreferenceFragment
         final PreferenceScreen prefScreen = getPreferenceScreen();
 
         final boolean hasPowerKey = DeviceUtils.hasPowerKey();
-        final boolean hasHomeKey = DeviceUtils.hasHomeKey(getActivity());
+        final boolean hasHomeKey = false;//DeviceUtils.hasHomeKey(getActivity());
         final boolean hasBackKey = DeviceUtils.hasBackKey(getActivity());
-        final boolean hasMenuKey = false;
+        final boolean hasMenuKey = true;
         final boolean hasAssistKey = false;
         final boolean hasAppSwitchKey = false;
         final boolean hasCameraKey = false;
@@ -219,6 +221,8 @@ public class ButtonSettings extends SettingsPreferenceFragment
                 org.lineageos.platform.internal.R.integer.config_longPressOnHomeBehavior));
         Action defaultHomeDoubleTapAction = Action.fromIntSafe(res.getInteger(
                 org.lineageos.platform.internal.R.integer.config_doubleTapOnHomeBehavior));
+        Action defaultPowerButtonAction = Action.fromIntSafe(res.getInteger(
+                org.lineageos.platform.internal.R.integer.config_powerButtonBehavior));
         Action defaultDpadScreenOffAction = Action.fromIntSafe(res.getInteger(
                 org.lineageos.platform.internal.R.integer.config_screenOffDpadBehavior));
         Action defaultDpadMusicPlayingAction = Action.fromIntSafe(res.getInteger(
@@ -236,6 +240,9 @@ public class ButtonSettings extends SettingsPreferenceFragment
         Action homeDoubleTapAction = Action.fromSettings(resolver,
                 LineageSettings.System.KEY_HOME_DOUBLE_TAP_ACTION,
                 defaultHomeDoubleTapAction);
+        Action powerButtonAction = Action.fromSettings(resolver,
+                LineageSettings.System.KEY_POWER_BUTTON_ACTION,
+                defaultPowerButtonAction);
         Action dpadScreenOffAction = Action.fromSettings(resolver,
                 LineageSettings.System.KEY_DPAD_SCREEN_OFF_ACTION,
                 defaultDpadScreenOffAction);
@@ -564,6 +571,14 @@ public class ButtonSettings extends SettingsPreferenceFragment
         mEdgeLongSwipeAction.setEntries(actionEntries);
         mEdgeLongSwipeAction.setEntryValues(actionValues);
 
+	mPowerButtonAction = initList(KEY_POWER_BUTTON_ACTION, powerButtonAction);
+        List<String> powerButtonEntries = new ArrayList<>(
+                Arrays.asList(res.getStringArray(R.array.power_button_action_entries)));
+        List<String> powerButtonValues = new ArrayList<>(
+                Arrays.asList(res.getStringArray(R.array.power_button_action_values)));
+        mPowerButtonAction.setEntries(powerButtonEntries.toArray(new String[0]));
+        mPowerButtonAction.setEntryValues(powerButtonValues.toArray(new String[0]));
+
 	mDpadScreenOffAction = initList(KEY_DPAD_SCREEN_OFF, dpadScreenOffAction);
 	mDpadMusicPlayingAction = initList(KEY_DPAD_MUSIC_PLAYING, dpadMusicPlayingAction);
 	mDpadCallActiveAction = initList(KEY_DPAD_CALL_ACTIVE, dpadCallActiveAction);
@@ -643,6 +658,10 @@ public class ButtonSettings extends SettingsPreferenceFragment
             handleListChange((ListPreference) preference, newValue,
                     LineageSettings.System.KEY_HOME_LONG_PRESS_ACTION);
             return true;
+        } else if (preference == mPowerButtonAction) {
+            handleListChange((ListPreference) preference, newValue,
+                    LineageSettings.System.KEY_POWER_BUTTON_ACTION);
+            return true;
         } else if (preference == mDpadScreenOffAction) {
             handleListChange((ListPreference) preference, newValue,
                     LineageSettings.System.KEY_DPAD_SCREEN_OFF_ACTION);
-- 
2.34.1

