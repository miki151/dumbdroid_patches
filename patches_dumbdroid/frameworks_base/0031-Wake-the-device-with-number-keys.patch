From 01cfd0a52f787475319bec96554af2c96a1dee83 Mon Sep 17 00:00:00 2001
From: Michal Brzozowski <miki@extremic.com>
Date: Tue, 7 Oct 2025 09:24:07 +0200
Subject: [PATCH 31/46] Wake the device with number keys

Change-Id: I5176447beabad7cab19110711a72794843316faa
---
 .../server/policy/PhoneWindowManager.java     | 35 ++++++++++++++-----
 1 file changed, 27 insertions(+), 8 deletions(-)

diff --git a/services/core/java/com/android/server/policy/PhoneWindowManager.java b/services/core/java/com/android/server/policy/PhoneWindowManager.java
index dd31284c0a9e..e3ac86f76047 100644
--- a/services/core/java/com/android/server/policy/PhoneWindowManager.java
+++ b/services/core/java/com/android/server/policy/PhoneWindowManager.java
@@ -5394,6 +5394,7 @@ public class PhoneWindowManager implements WindowManagerPolicy {
         final boolean canceled = event.isCanceled();
         final int displayId = event.getDisplayId();
         final boolean isInjected = (policyFlags & WindowManagerPolicy.FLAG_INJECTED) != 0;
+        final boolean isNumberKey = isNumericKey(keyCode);
 
         // If screen is off then we treat the case where the keyguard is open but hidden
         // the same as if it were open and in front.
@@ -5437,14 +5438,26 @@ public class PhoneWindowManager implements WindowManagerPolicy {
             mPendingWakeKey = PENDING_KEY_NULL;
         } else {
             // When the screen is off and the key is not injected, determine whether
-            // to wake the device but don't pass the key to the application.
-            result = 0;
-            if (isWakeKey && (!down || !isWakeKeyWhenScreenOff(keyCode))) {
-                isWakeKey = false;
-            }
-            // Cache the wake key on down event so we can also avoid sending the up event to the app
-            if (isWakeKey && down) {
-                mPendingWakeKey = keyCode;
+            // to wake the device but don't pass the key to the application. Numeric keys are
+            // forwarded so they can unlock the keyguard PIN after waking the device.
+            if (isNumberKey) {
+                result = ACTION_PASS_TO_USER;
+                if (down) {
+                    isWakeKey = true;
+                } else {
+                    isWakeKey = false;
+                }
+                mPendingWakeKey = PENDING_KEY_NULL;
+            } else {
+                result = 0;
+                if (isWakeKey && (!down || !isWakeKeyWhenScreenOff(keyCode))) {
+                    isWakeKey = false;
+                }
+                // Cache the wake key on down event so we can also avoid sending the up event
+                // to the app
+                if (isWakeKey && down) {
+                    mPendingWakeKey = keyCode;
+                }
             }
         }
 
@@ -6100,6 +6113,12 @@ public class PhoneWindowManager implements WindowManagerPolicy {
         }
     }
 
+    private static boolean isNumericKey(int keyCode) {
+        return (keyCode >= KeyEvent.KEYCODE_0 && keyCode <= KeyEvent.KEYCODE_9)
+                || (keyCode >= KeyEvent.KEYCODE_NUMPAD_0
+                && keyCode <= KeyEvent.KEYCODE_NUMPAD_9);
+    }
+
     /**
      * Check if the given keyCode represents a key that is considered a wake key
      * and is currently enabled by the user in Settings or for another reason.
-- 
2.34.1

