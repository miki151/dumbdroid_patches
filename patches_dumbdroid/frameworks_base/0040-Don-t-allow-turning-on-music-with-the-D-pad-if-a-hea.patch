From 9b4946af0546f44bab47319417ab65f69b0086ba Mon Sep 17 00:00:00 2001
From: Michal Brzozowski <miki@extremic.com>
Date: Sun, 2 Nov 2025 17:10:27 +0100
Subject: [PATCH 40/46] Don't allow turning on music with the D-pad if a
 headset isn't connected

Change-Id: Iefd5771e76a9cbb2eea6f4615f5989f609f148d6
---
 .../server/policy/PhoneWindowManager.java     | 26 +++++++++++++++++--
 1 file changed, 24 insertions(+), 2 deletions(-)

diff --git a/services/core/java/com/android/server/policy/PhoneWindowManager.java b/services/core/java/com/android/server/policy/PhoneWindowManager.java
index 1d8930a1e465..1ee1084f3134 100644
--- a/services/core/java/com/android/server/policy/PhoneWindowManager.java
+++ b/services/core/java/com/android/server/policy/PhoneWindowManager.java
@@ -481,6 +481,7 @@ public class PhoneWindowManager implements WindowManagerPolicy {
     PowerManagerInternal mPowerManagerInternal;
     IStatusBarService mStatusBarService;
     StatusBarManagerInternal mStatusBarManagerInternal;
+    AudioManager mAudioManager;
     AudioManagerInternal mAudioManagerInternal;
     SensorPrivacyManager mSensorPrivacyManager;
     DisplayManager mDisplayManager;
@@ -1188,6 +1189,28 @@ public class PhoneWindowManager implements WindowManagerPolicy {
         }
     }
 
+    private AudioManager getAudioManager() {
+        if (mAudioManager == null) {
+            mAudioManager = mContext.getSystemService(AudioManager.class);
+        }
+        return mAudioManager;
+    }
+
+    private boolean isMediaPlayingOrRoutedToExternalDevice() {
+        final AudioManager audioManager = getAudioManager();
+        if (audioManager == null) {
+            return false;
+        }
+        if (audioManager.isMusicActive()) {
+            return true;
+        }
+        final int devices = audioManager.getDevicesForStream(AudioManager.STREAM_MUSIC);
+        if (devices == 0) {
+            return false;
+        }
+	return (devices & (AudioManager.DEVICE_OUT_SPEAKER | AudioManager.DEVICE_OUT_EARPIECE)) == 0;
+    }
+
     AccessibilityManagerInternal getAccessibilityManagerInternal() {
         synchronized (mServiceAcquireLock) {
             if (mAccessibilityManagerInternal == null) {
@@ -5522,7 +5545,7 @@ public class PhoneWindowManager implements WindowManagerPolicy {
                 case KeyEvent.KEYCODE_DPAD_CENTER:
                 case KeyEvent.KEYCODE_DPAD_LEFT:
                 case KeyEvent.KEYCODE_DPAD_RIGHT:
-                    if (event.getRepeatCount() == 0) {
+                    if (isMediaPlayingOrRoutedToExternalDevice() && event.getRepeatCount() == 0) {
                         final int mediaKeyCode;
                         if (keyCode == KeyEvent.KEYCODE_DPAD_CENTER) {
                             mediaKeyCode = KeyEvent.KEYCODE_MEDIA_PLAY_PAUSE;
@@ -5531,7 +5554,6 @@ public class PhoneWindowManager implements WindowManagerPolicy {
                         } else {
                             mediaKeyCode = KeyEvent.KEYCODE_MEDIA_NEXT;
                         }
-
                         KeyEvent mediaKeyEvent = new KeyEvent(event.getDownTime(),
                                 event.getEventTime(), down ? KeyEvent.ACTION_DOWN
                                         : KeyEvent.ACTION_UP, mediaKeyCode, 0);
-- 
2.34.1

