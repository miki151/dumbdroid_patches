From 9c211097d8dacb9020b639bfe56f04034405c04d Mon Sep 17 00:00:00 2001
From: Michal Brzozowski <miki@extremic.com>
Date: Wed, 8 Oct 2025 09:51:03 +0200
Subject: [PATCH 32/44] Only let number keys wake the screen if there is a PIN
 set

Change-Id: I664f1e25b860a305d46b5bdb73fdde7806ee7be2
---
 .../server/policy/PhoneWindowManager.java        | 16 ++++++++++++++--
 1 file changed, 14 insertions(+), 2 deletions(-)

diff --git a/services/core/java/com/android/server/policy/PhoneWindowManager.java b/services/core/java/com/android/server/policy/PhoneWindowManager.java
index e3ac86f76047..542b8c2b2b85 100644
--- a/services/core/java/com/android/server/policy/PhoneWindowManager.java
+++ b/services/core/java/com/android/server/policy/PhoneWindowManager.java
@@ -110,6 +110,7 @@ import android.app.ActivityManager.RecentTaskInfo;
 import android.app.ActivityManagerInternal;
 import android.app.ActivityTaskManager;
 import android.app.ActivityTaskManager.RootTaskInfo;
+import android.app.admin.DevicePolicyManager;
 import android.app.AlarmManager;
 import android.app.AppOpsManager;
 import android.app.IActivityManager;
@@ -5395,6 +5396,7 @@ public class PhoneWindowManager implements WindowManagerPolicy {
         final int displayId = event.getDisplayId();
         final boolean isInjected = (policyFlags & WindowManagerPolicy.FLAG_INJECTED) != 0;
         final boolean isNumberKey = isNumericKey(keyCode);
+        final boolean allowNumberKeyWake = isNumberKey && shouldWakeOnNumericKey();
 
         // If screen is off then we treat the case where the keyguard is open but hidden
         // the same as if it were open and in front.
@@ -5439,8 +5441,8 @@ public class PhoneWindowManager implements WindowManagerPolicy {
         } else {
             // When the screen is off and the key is not injected, determine whether
             // to wake the device but don't pass the key to the application. Numeric keys are
-            // forwarded so they can unlock the keyguard PIN after waking the device.
-            if (isNumberKey) {
+            // forwarded when a PIN lock is present so they can unlock the keyguard after waking.
+            if (allowNumberKeyWake) {
                 result = ACTION_PASS_TO_USER;
                 if (down) {
                     isWakeKey = true;
@@ -6119,6 +6121,16 @@ public class PhoneWindowManager implements WindowManagerPolicy {
                 && keyCode <= KeyEvent.KEYCODE_NUMPAD_9);
     }
 
+    private boolean shouldWakeOnNumericKey() {
+        if (mLockPatternUtils == null) {
+            return false;
+        }
+
+        final int quality = mLockPatternUtils.getKeyguardStoredPasswordQuality(mCurrentUserId);
+        return quality == DevicePolicyManager.PASSWORD_QUALITY_NUMERIC
+                || quality == DevicePolicyManager.PASSWORD_QUALITY_NUMERIC_COMPLEX;
+    }
+
     /**
      * Check if the given keyCode represents a key that is considered a wake key
      * and is currently enabled by the user in Settings or for another reason.
-- 
2.34.1

