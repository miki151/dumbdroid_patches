From 2f2f9c5c435b673b91abc7ed4c4301461b2108fa Mon Sep 17 00:00:00 2001
From: Michal Brzozowski <miki@extremic.com>
Date: Sun, 21 Sep 2025 08:37:33 +0200
Subject: [PATCH 2/8] Make settings scrollable with dpad

Change-Id: I476b37c1824b48f631ef9e9f46f5a74b70ab9ff5
---
 .../settings/homepage/TopLevelSettings.java   | 50 +++++++++++++++++++
 1 file changed, 50 insertions(+)

diff --git a/src/com/android/settings/homepage/TopLevelSettings.java b/src/com/android/settings/homepage/TopLevelSettings.java
index f76815c0eda..d26a5c1258f 100644
--- a/src/com/android/settings/homepage/TopLevelSettings.java
+++ b/src/com/android/settings/homepage/TopLevelSettings.java
@@ -31,8 +31,10 @@ import android.view.KeyEvent;
 import android.view.LayoutInflater;
 import android.view.View;
 import android.view.ViewGroup;
+import android.view.ViewTreeObserver;
 
 import androidx.annotation.VisibleForTesting;
+import androidx.core.view.ViewCompat;
 import androidx.fragment.app.Fragment;
 import androidx.preference.Preference;
 import androidx.preference.PreferenceFragmentCompat;
@@ -269,6 +271,26 @@ public class TopLevelSettings extends DashboardFragment implements SplitLayoutLi
             }
             return false;
         });
+
+        final ViewTreeObserver.OnGlobalFocusChangeListener focusChangeListener =
+                (oldFocus, newFocus) -> ensureRecyclerViewItemVisible(recyclerView, newFocus);
+        recyclerView.addOnAttachStateChangeListener(new View.OnAttachStateChangeListener() {
+            @Override
+            public void onViewAttachedToWindow(View v) {
+                v.getViewTreeObserver().addOnGlobalFocusChangeListener(focusChangeListener);
+            }
+
+            @Override
+            public void onViewDetachedFromWindow(View v) {
+                final ViewTreeObserver observer = v.getViewTreeObserver();
+                if (observer.isAlive()) {
+                    observer.removeOnGlobalFocusChangeListener(focusChangeListener);
+                }
+            }
+        });
+        if (recyclerView.isAttachedToWindow()) {
+            recyclerView.getViewTreeObserver().addOnGlobalFocusChangeListener(focusChangeListener);
+        }
         return recyclerView;
     }
 
@@ -414,6 +436,34 @@ public class TopLevelSettings extends DashboardFragment implements SplitLayoutLi
         void doForEach(Preference preference);
     }
 
+    private void ensureRecyclerViewItemVisible(RecyclerView recyclerView, View newFocus) {
+        if (newFocus == null || recyclerView == null) {
+            return;
+        }
+        if (!ViewCompat.isLaidOut(recyclerView) || !recyclerView.isAttachedToWindow()) {
+            return;
+        }
+        final RecyclerView.LayoutManager layoutManager = recyclerView.getLayoutManager();
+        if (layoutManager == null || !layoutManager.canScrollVertically()) {
+            return;
+        }
+        final View itemView = recyclerView.findContainingItemView(newFocus);
+        if (itemView == null) {
+            return;
+        }
+
+        final int parentTop = recyclerView.getPaddingTop();
+        final int parentBottom = recyclerView.getHeight() - recyclerView.getPaddingBottom();
+        final int decoratedTop = layoutManager.getDecoratedTop(itemView);
+        final int decoratedBottom = layoutManager.getDecoratedBottom(itemView);
+
+        if (decoratedTop < parentTop) {
+            recyclerView.scrollBy(0, decoratedTop - parentTop);
+        } else if (decoratedBottom > parentBottom) {
+            recyclerView.scrollBy(0, decoratedBottom - parentBottom);
+        }
+    }
+
     public static final BaseSearchIndexProvider SEARCH_INDEX_DATA_PROVIDER =
             new BaseSearchIndexProvider(R.xml.top_level_settings) {
 
-- 
2.34.1

